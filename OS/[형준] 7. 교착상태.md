# 교착상태란?
> 다른 블록된 스레드가 사용중인 자원의 해제를 기다리면서 자신도 블록된 스레드가 요청하고 있는 자원을 사용하고 있는 경우(병행처리 지원에서 발생)

- 교착 상태는 커널 내에서도 발생하지만 주로 사용자가 작성한 멀티 스레드 응용프로그램에서 발생
- 교착 상태를 막는데 많은 시간과 공간 비용이 발생하기 때문에 막는 것은 사실상 불가능하다.
- 따라서 교착 상태가 발생하도록 두고, 교착상태가 발생한 것 같으면 시스템을 재시작 하거나 의심스러운 몇몇 프로그램을 종료하는 방식으로 해결한다.

### 교착상태 예시

- 예시
    스레드 Q는 프린터 자원을 사용중이면서 DVD 드라이브 자원을 요청하고 있다.
    스레드 P는 DVD 드라이브 자원을 사용하면서 프린터 자원을 요청하고 있다.
    ![alt text](./[형준]%20Image/image-8.png)

- 식사하는 철학자 문제
  ![alt text](./[형준]%20Image/image-9.png)
  - **조건**
    - 식사를 하기 위해서는 양쪽 포크를 확보해야 함
    - 왼쪽 포크를 먼저 들고 오른족 포크를 듬
    - 포크가 사용중이면 대기
  - **교착상태 원인 - 환형 요청/대기(circular wait)**
    - 모두 동시에 식사를 하며 왼쪽 포크를 든 후 오른쪽 포크를 들려고 할 때, 교착 상태 발생 -> 환형 대기
      - 환형 대기는 스스로 인식하거나 해체 불가능
  - **교착상태 해결 - 환형 대기 생기지 않도록 조정**
    - 철학자들이 각자 적절한 시간을 두고 식사를 하게 하거나
    - 마지막 철학자만 오른쪽 포크를 먼저 잡고 왼쪽을 잡도록 규칙 수정
        ![alt text](./[형준]%20Image/image-10.png)

  - 식사하는 철학자 문제를 컴퓨터 시스템으로 표현
    - 철학자 == 스레드
    - 포크 == 자원
    - 음식 == 스레드가 처리할 작업

    ![alt text](./[형준]%20Image/image-11.png)

### 전형적인 멀티스레드 교착 상태 사례
2개의 스레드가 각각 락(자원)을 소유한 상태에서, 서로 상대가 가진 락(lock, 자원)을 요청하는 상황
![alt text](./[형준]%20Image/image-12.png)

락과 자원에 대한 경쟁이 있는 한 교착상태는 언제든 발생할 수 있다.

### 컴푸터 시스템에 잠재된 교착상태 유발 요인

- **자원과 스레드**
  - 한 스레드가 여러 자원을 동시에 필요로 하는 상황
- **자원과 운영체제**
  - 한 번에 하나씩 자원을 할당하는 운영체제 정책
    - 필요로 하는 자원을 한 번에 모두 요청하고 할당한다면 교착상태가 발생하지 않는다.
      - ex. 스레드 A가 X, Y 자원을 요청하고 스레드 B가 Y, X 자원을 요청할 때 스레드 A에게 X, Y 자원을 모두 할당하면 교착 상태가 발생하지 않음
- **자원 비선점**
  - 할당된 자원은 스레드가 자발적으로 해제하기 전에 뺏지 못하는 비선점 정책
    - 만약 자원을 선점 가능하도록 바꾼다면 교착상태가 발생하지 않게 할 수 있음

### 자원 할당 그래프
- 스레드 == 원
- 자원 == 사각형
- 간선 == 소유/요청 관계

![alt text](./[형준]%20Image/image-13.png)

#### 교착상태 발생 그래프
![alt text](./[형준]%20Image/image-14.png)

# 교착상태 원인과 해결 방법

## 코프만 조건
> 교착상태가 발생하는 4가지 필요충분 조건

- 상호 배제(Mutual Exclusion)
  - 각 자원은 한 번에 한 스레드에게만 할당
- 소유 대기(Hold & Wait)
  - 스레드가 한 자원을 소유하면서 그 자원을 반납하지 않고 다른 자원 요청하며 대기
- 강제 자원 반환 불가(No Preemption)
  - 스레드에게 할당된 자원을 강제로 빼앗지 못하는 비선점 조건
- 환형 대기(Circular Wait)
  - 한 그룹의 스레드들에 대해, 각 스레드는 다른 스레드가 요청하는 자원을 소유하는 환형 고리

4가지 모두 발생해야 교착상태 발생하지만 그렇다고 꼭 교착상태가 발생하는 건 아니다.

## 교착상태 해결 방법

### 교착상태 예방(prevention) - 비현실적
> 코프만 조건 4가지 중 최소 하나를 성립하지 못하게 해서 교착상태를 예방
이 방식은 현실적으로 불가능하다.

- 상호 배제(Mutual Exclusion) 제거
  - 여러 스레드가 하나의 자원을 사용하는 것 -> 불가능

- 소유 대기(Hold & Wait) 제거
  - 방법
    - 운영체제는 특정 스레드의 실행 전에 특정 스레드가 필요로 하는 모든 자원을 파악하고 실행 시 한 번에 모두 할당
      - 당장 사용하지 않는 자원을 할당하면 자원 활용률이 저하됨
      - 자원을 필요로하는 다른 스레드는 대기해야 함
    - 스레드가 새로운 자원을 요청하려면, 오히려 현재 할당 받은 모든 자원들을 반환한 후 한꺼번에 요청하여 할당
  - 두 가지 방법은 모두 불가능하거나 매우 비효율적이라 사용하지 않음

- 강제 자원 반환 불가(No Pre-emption) 제거
  - 선점 방식으로 변경 -> 복잡하고 잦은 스케줄링으로 인해 오버헤드가 큼
- 환형 대기(Circular Wait) 제거 - 이해X
  - 모든 자원에 번호를 매기고, 하나의 스레드에서 복수개의 자원을 요청 시 번호순으로 자원 할당
  ![alt text](./[형준]%20Image/image-15.png)

### 교착상태 회피(avoidance) - 비현실적
> 자원 할당 시에 미래에 환영 대기가 발생할 것으로 판단되면 자원을 할당하지 않는 방식

- 문제점
  - 자원 할당 시마다 교착상태 가능성을 검사해야해서 시스템 성능이 저하
  - 미래에 발생 할지 안할지는 알 수 없음

#### 은행원 알고리즘(banker’s algorithm)
> 다익스트라에 의해 개발된 알고리즘으로 자원 할당 전에 미래에 교착상태가 발생하지 않을 것인지 안전한지 판단하는 알고리즘

- 안전한 상태
  > 교착상태가 발생하지 않도록 프로세스에게 자원을 할당할 수 있는 경로가 존재하는 경우
    - 필요시 프로세스의 순서를 바꾸어서라도 가능하다면 안전한 상태

- 불안전한 상태
  > 교착상태가 발생하지 않도록 프로세스에게 자원을 할당할 수 있는 경로가 존재하지 않는 경우
  - 반드시 교착상태가 발생하는 것은 아니고 가능성이 높은 상태를 의미
    - ex. 프로세스가 중간에 자원을 반납하면 교착상태 발생X

- 알고리즘
  1. 각 프로세스가 실행 시작 전에 필요한 전체 자원의 수를 운영체제에 알림
  2. 자원을 할당할 때마다, 자원을 할당해주었을 때 교착상태가 발생하지 않을 만큼 안전한 상태인지 판단하여 안전한 상태일 때만 자원 할당

- 다음과 같은 이유로 비현실적인 방법이다.
  - 각 프로세스가 실행 전에 필요한 자원의 개수를 아는 것은 불가능하다.
  - 프로세스의 개수도 동적으로 변하기 때문에, 미리 프로세스의 개수를 정적으로 고정시키는 것은 불가능하다.

### 교착상태 감지 및 복구(detection and recovery) - 가능하지만 CPU 부담 너무 큼
> 자원 할당시에 아무런 고려사항 없이 할당해 주고, 교착상태 감지시에 형성된 교착상태를 푸는 방식

- 문제점
  - 백그라운드에서 교착상태를 감지해야 하는 프로세스가 항상 실행되어야 해서 CPU에 부담이 크다.
  - 시간과 메모리 공간(롤백 방법)에 대한 부담이 큼 

- 교착상태를 감지했을 때 복구 방법
  - **자원 강제 선점(preemption)**
    - 교착상태에 빠진 스레드 중 하나의 자원을 강제로 빼앗아 다른 스레드에게 할당
    - 문제점
      - 자원을 강제로 빼앗긴 스레드에 문제 발생
  - **롤백(rollback)**
    - 교착상태가 발생할 것으로 예측되는 스레드들의 상태를 주기적으로 저장, 교착상태가 발생하면 마지막 저장 상태로 돌아가도록 함
    - 문제점
      - 마지막 상태로 돌아가서 다시 시작하면 스케줄링 등의 여러 요인에 의해 자원 할당 순서가 달라질 가능성이 매우 높음
  - **스레드 강제 종료(kill process)**
    - 교착상태에 빠진 스레드 중 하나를 선택하여 강제 종료
    - 문제점
      - 종료된 스레드에 피해 발생

### 교착상태 무시(타조 알고리즘) - 현실적인 방법
> 교착상태가 일어나지 않을 것으로 가정하고, 교착상태를 예방하거나 해결하려는 별도의 조치를 취하지 않고 이를 무시하고 교착상태가 발생하면 그때 가서 스레드를 종료하거나 시스템을 재시작하는 방법

- 교착상태는 반드시 발생하지만 발생 가능성이 매우매우 낮고 피하기 위한 방법을 사용하면 너무 많은 비용이 소요된다.
- 따라서 발생하지 않을 거라 가정하고 아무 대책 없이 일단 할당한 후 교착 상태가 발생하면 의심 가는 스레드를 종료 시키거나 시스템 재시작 하는 방법으로 해결하는 방법이다.
- 현재 대부분의 운영체제에서 사용하는 가장 일반적인 방법이다.
- 시스템 재시작이 큰 문제가 되는 실시간 시스템에는 적용하면 안되는 방법이다.(미사일, 비행기 등)
